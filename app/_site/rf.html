<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Aidan Neeson - CMPSC 610 Artifact - Random Forest Regression on Geospatial Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Aidan Neeson - CMPSC 610 Artifact</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./data.html"> 
<span class="menu-text">Data</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./rf.html" aria-current="page"> 
<span class="menu-text">Random Forest</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./svm.html"> 
<span class="menu-text">SVM</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./ann.html"> 
<span class="menu-text">ANN</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-random-forest-regressor" id="toc-the-random-forest-regressor" class="nav-link active" data-scroll-target="#the-random-forest-regressor">The Random Forest Regressor</a>
  <ul class="collapse">
  <li><a href="#getting-a-trained-model" id="toc-getting-a-trained-model" class="nav-link" data-scroll-target="#getting-a-trained-model">Getting a Trained Model</a>
  <ul class="collapse">
  <li><a href="#data-and-preprocessing" id="toc-data-and-preprocessing" class="nav-link" data-scroll-target="#data-and-preprocessing">Data and Preprocessing</a></li>
  <li><a href="#training-a-random-forest-regressor" id="toc-training-a-random-forest-regressor" class="nav-link" data-scroll-target="#training-a-random-forest-regressor">Training a Random Forest Regressor</a></li>
  </ul></li>
  <li><a href="#analyzing-and-assesing-the-random-forest" id="toc-analyzing-and-assesing-the-random-forest" class="nav-link" data-scroll-target="#analyzing-and-assesing-the-random-forest">Analyzing and Assesing the Random Forest</a>
  <ul class="collapse">
  <li><a href="#model-visualizations" id="toc-model-visualizations" class="nav-link" data-scroll-target="#model-visualizations">Model Visualizations</a></li>
  <li><a href="#metrics-reporting" id="toc-metrics-reporting" class="nav-link" data-scroll-target="#metrics-reporting">Metrics Reporting</a></li>
  <li><a href="#feature-importance" id="toc-feature-importance" class="nav-link" data-scroll-target="#feature-importance">Feature Importance</a></li>
  <li><a href="#k-fold-cross-validation" id="toc-k-fold-cross-validation" class="nav-link" data-scroll-target="#k-fold-cross-validation">K-Fold Cross Validation</a></li>
  </ul></li>
  <li><a href="#a-note-about-the-solar-data" id="toc-a-note-about-the-solar-data" class="nav-link" data-scroll-target="#a-note-about-the-solar-data">A Note About the Solar Data</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-notebooks"><h2>Notebooks</h2><ul><li><a href="1-datasets-preview.html"><i class="bi bi-journal-code"></i>Data Preview</a></li><li><a href="2-rf-wind-preview.html"><i class="bi bi-journal-code"></i>Random Forest Regression Process and Analysis for Wind Data</a></li><li><a href="2-rf-solar-preview.html"><i class="bi bi-journal-code"></i>Random Forest Regression Process and Analysis for Wind Data</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Random Forest Regression on Geospatial Data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="the-random-forest-regressor" class="level1">
<h1>The Random Forest Regressor</h1>
<p>The Random Forest model is an simple, easy to use model that offers good results on a consistent basis for a wide range of applications. One of the areas that it is known to perform quite well in, is geospatial applications. Because of this, there is no doubt it was one of the algorithms chosen for this projects’ analysis. The “regressor” in Random Forest Regressor, stems from the use of strictly numeric data points in the project, which is analyzed most effectively through regressions. Below, the steps to use the <code>Random Forest Regressor</code> model from <code>sklearn</code> on the datasets in breifly outlined. To fill in those blanks, the relative notebooks are linked on the side.</p>
<section id="getting-a-trained-model" class="level2">
<h2 class="anchored" data-anchor-id="getting-a-trained-model">Getting a Trained Model</h2>
<p>The process for getting to trained model is flushed out in detail below. The other algorithms covered will not be covered in as great as detail for the sake of reducing repetition. Any differences that stand out between the models will be covered on their respective page. Otherwise, the process remains generally the same, if not exactly the same, at a high level.</p>
<section id="data-and-preprocessing" class="level3">
<h3 class="anchored" data-anchor-id="data-and-preprocessing">Data and Preprocessing</h3>
<p>The first step when performing any kind of machine learning problem or analysis is to read in the data, make alterations to it, and select features for training and testing. For this showcase, we will look at the <a href="https://data.nrel.gov/submissions/54">wind</a> data:</p>
<div class="quarto-embed-nb-cell">
<div id="cell-wind-dataset-preview" class="cell" data-execution_count="6">
<div id="wind-dataset-preview" class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">lat</th>
<th data-quarto-table-cell-role="th">long</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">farm_type</th>
<th data-quarto-table-cell-role="th">wind_speed</th>
<th data-quarto-table-cell-role="th">lcoe</th>
<th data-quarto-table-cell-role="th">capacity</th>
<th data-quarto-table-cell-role="th">capacity_factor</th>
<th data-quarto-table-cell-role="th">available_wind_power</th>
<th data-quarto-table-cell-role="th">available_energy</th>
<th data-quarto-table-cell-role="th">generated_energy</th>
<th data-quarto-table-cell-role="th">cost</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>25.896492</td>
<td>-97.460358</td>
<td>Texas</td>
<td>onshore</td>
<td>7.46</td>
<td>31</td>
<td>2</td>
<td>0.433</td>
<td>1.997163</td>
<td>17495.14630</td>
<td>7575.398348</td>
<td>4.696747e+06</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>26.032654</td>
<td>-97.738098</td>
<td>Texas</td>
<td>onshore</td>
<td>7.45</td>
<td>31</td>
<td>10</td>
<td>0.414</td>
<td>9.945710</td>
<td>87124.42376</td>
<td>36069.511440</td>
<td>2.236310e+07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>26.059063</td>
<td>-97.208252</td>
<td>Texas</td>
<td>onshore</td>
<td>8.18</td>
<td>31</td>
<td>2</td>
<td>0.506</td>
<td>2.633037</td>
<td>23065.40088</td>
<td>11671.092850</td>
<td>7.236078e+06</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3</td>
<td>26.078449</td>
<td>-98.073364</td>
<td>Texas</td>
<td>onshore</td>
<td>7.17</td>
<td>31</td>
<td>16</td>
<td>0.363</td>
<td>14.185493</td>
<td>124264.92160</td>
<td>45108.166540</td>
<td>2.796706e+07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>4</td>
<td>26.143227</td>
<td>-98.311340</td>
<td>Texas</td>
<td>onshore</td>
<td>7.06</td>
<td>31</td>
<td>16</td>
<td>0.358</td>
<td>13.542570</td>
<td>118632.91080</td>
<td>42470.582050</td>
<td>2.633176e+07</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-1" href="1-datasets-preview.html#cell-wind-dataset-preview">Source: Data Preview</a></div>
<p>The dataset as it is, potentially has a lot of bias due to its structure and ordering. Although a human may not be able to see a pattern in the order the way the data as been recorded, a machine learning model is very sensitive to nuances like this. To reduce this being a factor, the dataset must be shuffled. A method from the Python package <code>pandas</code> can do this very easily, that method being <code>sample()</code>. Once it is used, the dataset ends up looking like this:</p>
<div class="quarto-embed-nb-cell">
<div id="cell-shuffled-dataset-preview" class="cell" data-execution_count="3">
<div id="shuffled-dataset-preview" class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">lat</th>
<th data-quarto-table-cell-role="th">long</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">farm_type</th>
<th data-quarto-table-cell-role="th">wind_speed</th>
<th data-quarto-table-cell-role="th">lcoe</th>
<th data-quarto-table-cell-role="th">capacity</th>
<th data-quarto-table-cell-role="th">capacity_factor</th>
<th data-quarto-table-cell-role="th">available_wind_power</th>
<th data-quarto-table-cell-role="th">available_energy</th>
<th data-quarto-table-cell-role="th">generated_energy</th>
<th data-quarto-table-cell-role="th">cost</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">104321</td>
<td>104321</td>
<td>47.115517</td>
<td>-106.994720</td>
<td>Montana</td>
<td>onshore</td>
<td>8.08</td>
<td>31</td>
<td>16</td>
<td>0.439</td>
<td>20.301170</td>
<td>177838.24560</td>
<td>78070.98984</td>
<td>48404013.70</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">44108</td>
<td>44108</td>
<td>40.504593</td>
<td>-87.896454</td>
<td>Illinois</td>
<td>onshore</td>
<td>7.16</td>
<td>36</td>
<td>16</td>
<td>0.374</td>
<td>14.126223</td>
<td>123745.70950</td>
<td>46280.89535</td>
<td>33322244.65</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">19515</td>
<td>19515</td>
<td>36.364742</td>
<td>-88.897675</td>
<td>Tennessee</td>
<td>onshore</td>
<td>6.74</td>
<td>45</td>
<td>16</td>
<td>0.387</td>
<td>11.783293</td>
<td>103221.64420</td>
<td>39946.77632</td>
<td>35952098.69</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4940</td>
<td>4940</td>
<td>32.670708</td>
<td>-102.887939</td>
<td>Texas</td>
<td>onshore</td>
<td>7.34</td>
<td>31</td>
<td>16</td>
<td>0.411</td>
<td>15.218616</td>
<td>133315.07550</td>
<td>54792.49602</td>
<td>33971347.53</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">70776</td>
<td>70776</td>
<td>39.942379</td>
<td>-122.230392</td>
<td>California</td>
<td>onshore</td>
<td>6.11</td>
<td>47</td>
<td>16</td>
<td>0.338</td>
<td>8.778304</td>
<td>76897.94144</td>
<td>25991.50421</td>
<td>24432013.95</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-2" href="2-rf-wind-preview.html#cell-shuffled-dataset-preview">Source: Random Forest Regression Process and Analysis for Wind Data</a></div>
<p>With the data shuffled, we can now ensure that the training and testing splits have as little bias as possible, from an ordering perspective. Two different arrays must be made for each split, those being <code>X</code>, the inputs, and <code>y</code>, the outputs, or features to be predicted. For this project, we are interested in determining if a machine learning model is effective when only given locational data, and as little extra information as possible. So for our <code>X</code> variables, we chose <code>lat</code>, <code>long</code>, and <code>capacity</code>. For the <code>y</code>, <code>generated_energy</code> and <code>cost</code> were used, since these are the values we want to predict. The idea is that a hypothetical user should only need to input their location, and how big they want the wind turbine/farm to be, if they want predictions. For the splits, we reserve about 80% of the data for training, and 20% for testing.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df.loc[:, [<span class="st">'lat'</span>,<span class="st">'long'</span>,<span class="st">'capacity'</span>]]</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df.loc[:, [<span class="st">'generated_energy'</span>,<span class="st">'cost'</span>]]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> X[:<span class="dv">100000</span>]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> X[<span class="dv">100000</span>:]</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> y[:<span class="dv">100000</span>]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> y[<span class="dv">100000</span>:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>Notice that we are using two targets, this is because we are taking advantage of multioutput regression functionality. This saves on time and computational costs by creating one model that can predict two targets with one set of features.</p>
</blockquote>
<p>With shuffled training and testing splits, some changes must be made to the data to ensure it is easier for the model to process. Many machine learning models prefer having smaller numbers, ideally numbers between [1,-1]. From the dataset above, this is clearly not the case. To get close to this ideal, a <code>scaler</code> is used. A <code>scaler</code> will take the entire dataset, and apply a transformation to every feature, making the numbers smaller, and easier for a model to work with, without losing the meaning the original data had. For this project, <code>sklearn</code>’s <code>StandardScaler</code> was used. <strong>Note</strong>: The <code>scaler</code> is only used on the inputs, not on the outputs. It would not change the results, but it would supply an illusion that the model is performing better.</p>
<div class="quarto-embed-nb-cell">
<div id="cell-scaled-data" class="cell" data-execution_count="6">
<div id="scaled-data" class="cell-output cell-output-display" data-execution_count="6">
<pre><code>array([[ 1.50475958, -0.69192413,  0.51463162],
       [-0.00765112,  0.91790859,  0.51463162],
       [-0.95474337,  0.83351358,  0.51463162],
       ...,
       [ 0.20099693, -0.87590282, -0.07786604],
       [-0.09467121, -0.45629192,  0.51463162],
       [ 1.00200959,  0.73976282,  0.51463162]])</code></pre>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-3" href="2-rf-wind-preview.html#cell-scaled-data">Source: Random Forest Regression Process and Analysis for Wind Data</a></div>
<p>Now, the data is ready to be used to train a Random Forest Regressor model.</p>
</section>
<section id="training-a-random-forest-regressor" class="level3">
<h3 class="anchored" data-anchor-id="training-a-random-forest-regressor">Training a Random Forest Regressor</h3>
<p>This research is interested in determining if <em>simple</em> machine learning models can effectively predict renewable energy array parameters. To exaggerate this point, the models were used in the most out-of-the-box way possible, keeping things very simple. To train the model, the training data is passed into the <code>Random Forest Regressor</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>reg <span class="op">=</span> RandomForestRegressor()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>reg.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This ends up creating a large amount of individual decision trees, making up a forest. Each tree uses the input features as decision making points, splitting nodes in the tree based on how well a feature is contributing towards making better predictions. Because of the scale of the data, the trees are very large, but the general structure of the first few nodes looks like this:</p>
<div class="quarto-embed-nb-cell">
<div id="cell-fig-decision-tree" class="cell" data-execution_count="15">
<div class="cell-output cell-output-display">
<div id="fig-decision-tree" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-decision-tree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf_files/figure-html/2-rf-wind-fig-decision-tree-output-1.png" id="fig-decision-tree" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-decision-tree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1
</figcaption>
</figure>
</div>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-4" href="2-rf-wind-preview.html#cell-fig-decision-tree">Source: Random Forest Regression Process and Analysis for Wind Data</a></div>
<p>With a trained model, predictions can be made using the <code>predict()</code> method. Below are some predicted values compared to the true values.</p>
<div class="quarto-embed-nb-cell">
<div id="prediction-comparisons" class="cell" data-execution_count="8">
<div class="cell-output cell-output-stdout">
<pre><code>Predictions
----------------------
predicted energy: 39496.22  actual energy: 40307.25 predicted cost: 23697732.20 actual cost: 24184348.66
predicted energy: 102419.64 actual energy: 101556.00    predicted cost: 61451784.90 actual cost: 60933600.27
predicted energy: 49848.14  actual energy: 128958.46    predicted cost: 32899772.22 actual cost: 85112586.37</code></pre>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-5" href="2-rf-wind-preview.html#cell-prediction-comparisons">Source: Random Forest Regression Process and Analysis for Wind Data</a></div>
<p>The values are fairly close, especially when considering how little information the model is using to make the predictions. This indicates that there is some potential that general location-based information is enough to estimate the energy generation and cost of a wind turbine/farm.</p>
</section>
</section>
<section id="analyzing-and-assesing-the-random-forest" class="level2">
<h2 class="anchored" data-anchor-id="analyzing-and-assesing-the-random-forest">Analyzing and Assesing the Random Forest</h2>
<p>There are many ways to evaluate the performace of a model. Some of these are model dependent, like feature importance for a Random Forest. Others can be done to any model, like reporting metrics, or performing k-fold cross validation. Outlined below, are the strategies used to evaluate the performance of the <code>Random Forest Regressor</code> used in this project.</p>
<section id="model-visualizations" class="level3">
<h3 class="anchored" data-anchor-id="model-visualizations">Model Visualizations</h3>
<p>A helpful way to assess a machine learning model is to plot the model against the data being used. This allows for one to see the how the predictive model is fitting to the data. Below are the graphs for each feature, for each target:</p>
<div class="quarto-embed-nb-cell">
<div id="cell-fig-generated-energy-vs-input-features" class="cell" data-execution_count="14">
<div class="cell-output cell-output-display">
<div id="fig-generated-energy-vs-input-features" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-generated-energy-vs-input-features-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf_files/figure-html/2-rf-wind-fig-generated-energy-vs-input-features-output-1.png" id="fig-generated-energy-vs-input-features" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-generated-energy-vs-input-features-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2
</figcaption>
</figure>
</div>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-6" href="2-rf-wind-preview.html#cell-fig-generated-energy-vs-input-features">Source: Random Forest Regression Process and Analysis for Wind Data</a></div>
<div class="quarto-embed-nb-cell">
<div id="cell-fig-cost-vs-input-features" class="cell" data-execution_count="15">
<div class="cell-output cell-output-display">
<div id="fig-cost-vs-input-features" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cost-vs-input-features-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf_files/figure-html/2-rf-wind-fig-cost-vs-input-features-output-1.png" id="fig-cost-vs-input-features" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-cost-vs-input-features-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3
</figcaption>
</figure>
</div>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-7" href="2-rf-wind-preview.html#cell-fig-cost-vs-input-features">Source: Random Forest Regression Process and Analysis for Wind Data</a></div>
<p>The curves are not as smooth as one might hope, but they seem to represent the data in a fair way, although it is hard to fully capture due to how many data points there really are. While being able to visualize the models in the context of the data, more information is needed to truly be able to evaluate how well the model is performing. For that, we use metrics.</p>
<blockquote class="blockquote">
<p>It is important to note that these are the predictive models for each feature, and not the overall curve for the entire model.</p>
</blockquote>
</section>
<section id="metrics-reporting" class="level3">
<h3 class="anchored" data-anchor-id="metrics-reporting">Metrics Reporting</h3>
<p>To evaluate the machine learning models, three metrics, available through <code>sklearn</code>, were chosen.</p>
<ol type="1">
<li>R2-score (R2) - a goodness-of-fit metric that indicates how well a plotted curve represents the data.</li>
<li>Root Mean Squared Error (RMSE) - an error metric that explicitly states the average distance between a predicted value and its true counterpart.</li>
<li>Mean Absolute Percentage Error (MAPE) - a goodness-of-fit metric that indicates the average percent error a prediction has relative to the true values.</li>
</ol>
<p>R2 and MAPE were chosen because they are very scale-independent, meaning the difference in size of the data’s features and outliers have less of an effect on the score. The data has many outliers, and the features values range drastically in size, sometimes by many orders of magnitude. Scale-independent metrics help to isolate these edge cases and provide scoring that is relative to the majority of the dataset.</p>
<p>RMSE was chosen because, unlike R2 and MAPE, it is very scale-dependent. Utilizing both types of metrics ensures that the full picture is uncovered, giving a better overall summary of performance. Even though the scale of the data and the outliers may abstract the meaning of the score somewhat, the scale can be used to help explain why the metric appears the way it does. In the end, it still provides valuable insights into the performance that could indicate pathways for improvement in the future.</p>
<p>A single report of metrics for an isolated training and testing session looks like this:</p>
<div class="quarto-embed-nb-cell">
<div id="metrics" class="cell" data-execution_count="9">
<div class="cell-output cell-output-stdout">
<pre><code>Metric  Score
-----------------------
r2  [0.9223821  0.89367722]
rmse    [   8843.51723011 6421746.41274378]
mape    [0.12902421 0.1288721 ]</code></pre>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-8" href="2-rf-wind-preview.html#cell-metrics">Source: Random Forest Regression Process and Analysis for Wind Data</a></div>
<blockquote class="blockquote">
<p>The metrics are separated for each target variable, the values on the left are for <code>generated_energy</code> predictions and the values on the right are for <code>cost</code> predictions.</p>
</blockquote>
<p>R2 values around .90 indicate desireable results. This means that 90% of the variance in the dataset can be explained by the model, meaning it is fitting the data well. The MAPE values rienforce this idea too. While MAPE values below 10% would be the most ideal, a MAPE of 13% indicates predictions are on average 13% off of what they should be. This is generally considered “good”.</p>
<p>The RMSE is where things get tricky. Individually, they are not too awful. Although they look large, they are inflated due to the scale of the data. When considering that the majority of the data for generated energy is in the tens of thousands, and for cost it is in the tens of millions, the ratio of the RMSE to this “median” value can be roughly approximated to around .30, or 30% for both targets. For a metric that is not best suited for a dataset of this type, 30% also can indicate promising results. Even though it is more than twice the MAPE, this is to be expected because of the scale issues mentioned prior. In the end, it highlights the issue posed by the dataset, but also can somewhat reinforce the idea that the model is performing well, if examined deep enough.</p>
</section>
<section id="feature-importance" class="level3">
<h3 class="anchored" data-anchor-id="feature-importance">Feature Importance</h3>
<p>In a Random Forest, the input features end up being “ranked” by importance. This means that some features are used to determine how the tree splits more than others. A higher importance indicates that a feature is being used more often, while a lower importance indicates the opposite. When assessing a Random Forest, it is nice to see an even split of importance across all features. This would indicate that all of the features are being used equally to get to predictions. This not only ensures the model is functioning properly, but it also ensures that the dataset is not skewed towards a single feature.</p>
<p>A plot of the feature importances, and their respective values are shown below:</p>
<div class="quarto-embed-nb-cell">
<div id="cell-fig-feature-importances" class="cell" data-execution_count="13">
<div class="cell-output cell-output-display">
<div id="fig-feature-importances" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-feature-importances-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="rf_files/figure-html/2-rf-wind-fig-feature-importances-output-1.png" id="fig-feature-importances" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-feature-importances-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4
</figcaption>
</figure>
</div>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-9" href="2-rf-wind-preview.html#cell-fig-feature-importances">Source: Random Forest Regression Process and Analysis for Wind Data</a></div>
<div class="quarto-embed-nb-cell">
<div id="feature-importances" class="cell" data-execution_count="10">
<div class="cell-output cell-output-stdout">
<pre><code>Importances
----------------------
capacity: 20.230960634451716
lat: 35.095811124953094
long: 44.67322824059519</code></pre>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-10" href="2-rf-wind-preview.html#cell-feature-importances">Source: Random Forest Regression Process and Analysis for Wind Data</a></div>
<p>While it is not an even split, each feature has an importance that is significant when regarding the creation of the model. This indicates that the model is functioning fairly well with how it is using the data, and it even goes so far as to reinforce that the dataset is construced in a meaningful and unbiased way. All of this points to the model being effective at making trustworthy predictions.</p>
</section>
<section id="k-fold-cross-validation" class="level3">
<h3 class="anchored" data-anchor-id="k-fold-cross-validation">K-Fold Cross Validation</h3>
<p>The last piece of assessment comes from k-fold cross validation. K-fold cross validation consists of splitting up the dataset into k folds, and using those folds for training and testing. Each fold produces a trained model that then has metrics taken from it, in this case it is the same metrics listed above. The end goal being to obtain averages for all of the desired metrics over the <em>entire</em> dataset. Even though we shuffled the dataset, some of the data is not being used for training. K-fold cross validation ensures that all of the data is being used for both training and testing at some point, resulting in more accurate reporting of metrics.</p>
<p>For this project, 10 folds were used. The results of running k-fold cross validation on the wind dataset is shown below.</p>
<div class="quarto-embed-nb-cell">
<div id="cell-k-fold-cross-validation-table" class="cell" data-execution_count="14">
<div class="cell-output cell-output-stdout">
<pre><code>10-Fold Cross Validation Scores
----------------------------------------------------
R2 Average: 0.9109908237527048
RMSE Average: 3181739.2057383326
MAPE Average: 0.13390596472645255</code></pre>
</div>
<div id="k-fold-cross-validation-table" class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fit_time</th>
<th data-quarto-table-cell-role="th">score_time</th>
<th data-quarto-table-cell-role="th">test_r2</th>
<th data-quarto-table-cell-role="th">test_rmse</th>
<th data-quarto-table-cell-role="th">test_mape</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>35.631838</td>
<td>0.412091</td>
<td>0.908636</td>
<td>3.244508e+06</td>
<td>0.126463</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>35.085633</td>
<td>0.407737</td>
<td>0.909902</td>
<td>3.194235e+06</td>
<td>0.134273</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>34.784758</td>
<td>0.409132</td>
<td>0.912724</td>
<td>3.128678e+06</td>
<td>0.129694</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>34.819360</td>
<td>0.401673</td>
<td>0.908216</td>
<td>3.253428e+06</td>
<td>0.126229</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>34.879103</td>
<td>0.404808</td>
<td>0.907344</td>
<td>3.241619e+06</td>
<td>0.137367</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>34.481580</td>
<td>0.417363</td>
<td>0.915569</td>
<td>3.113150e+06</td>
<td>0.137573</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>35.357341</td>
<td>0.434344</td>
<td>0.908085</td>
<td>3.232867e+06</td>
<td>0.148030</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>37.669082</td>
<td>0.456003</td>
<td>0.915380</td>
<td>3.138264e+06</td>
<td>0.137533</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>37.000147</td>
<td>0.439912</td>
<td>0.913334</td>
<td>3.138594e+06</td>
<td>0.128061</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>34.930129</td>
<td>0.409387</td>
<td>0.910719</td>
<td>3.132047e+06</td>
<td>0.133837</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-11" href="2-rf-wind-preview.html#cell-k-fold-cross-validation-table">Source: Random Forest Regression Process and Analysis for Wind Data</a></div>
<p>K-fold cross validation through <code>sklearn</code> does not support multioutput. Because of this, the metrics for both targets are averaged together, resulting in one metric that defines the model’s overall performance. This is okay for R2 and MAPE, as they are similar enough and scale-independent, so little information is lost or abstracted. RMSE, however, becomes slightly less meaningfull when averaged due to the difference in scale between <code>generated_energy</code> and <code>cost</code>. Averaging the separate RMSE’s from a single report results in an average RMSE of 3,137,778.11. Comparing this to the average RMSE from cross validation, they are fairly similar. It can then be assumed that the individual RMSE’s would be around the same, indicating that the averages for then entire dataset are still within reasonable bounds. A similar conclusion can be drawn regarding R2 and MAPE. These values are within the same bounds of acceptance as they were in the <a href="#metrics-reporting">metrics section</a>, indicating good results.</p>
</section>
</section>
<section id="a-note-about-the-solar-data" class="level2">
<h2 class="anchored" data-anchor-id="a-note-about-the-solar-data">A Note About the Solar Data</h2>
<p>The solar data is not, and will, not be covered in detail like the wind data was above. It was concluded that the solar data is insufficient for the project’s goals. The metrics that come from a model trained on solar data indicate more than just poor results. It is omitted to reduce confusion and bring to light the more impactful results of this experiment.</p>
<div class="quarto-embed-nb-cell">
<div id="metrics" class="cell" data-execution_count="9">
<div class="cell-output cell-output-stdout">
<pre><code>Metric  Score
-----------------------
r2  [1.         0.99947801]
rmse    [1.89379452e-12 1.36960035e+07]
mape    [9.69285180e-16 4.32843758e-03]</code></pre>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-12" href="2-rf-solar-preview.html#cell-metrics">Source: Random Forest Regression Process and Analysis for Wind Data</a></div>
<p>Numbers that look like this are intrinsic of bad models or bad data. In this case, it is bad data. The issue stems from what data was available publically and feasible to work with. Many gaps needed to be filled in, and not enough data was available to fill these gaps in in a way that did not comprimise the dataset in the end. The notebook is still available to view for purposes of experiment replication and validation.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>